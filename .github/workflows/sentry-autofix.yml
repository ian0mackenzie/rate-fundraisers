name: Sentry event alert â€“ create issue + assign Copilot

on:
  repository_dispatch:
    types: [sentry_event_alert]
  workflow_dispatch:
    inputs:
      sentry_json:
        description: "Raw Sentry JSON ({ issue, event }) for local testing"
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  COPILOT_ACTOR_ID: "BOT_kgDOC9w8XQ"

jobs:
  create_and_assign_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Sentry payload source and save to file
        env:
          SENTRY_FROM_DISPATCH: ${{ toJson(github.event.client_payload.sentry) }}
          SENTRY_FROM_INPUT: ${{ inputs.sentry_json }}
        run: |
          # Prefer repository_dispatch payload if present and not "null"
          if [ -n "$SENTRY_FROM_DISPATCH" ] && [ "$SENTRY_FROM_DISPATCH" != "null" ]; then
            echo "Writing Sentry payload from repository_dispatch"
            printf '%s\n' "$SENTRY_FROM_DISPATCH" > sentry-event.json
          else
            echo "No client_payload.sentry found, using workflow_dispatch input"
            printf '%s\n' "$SENTRY_FROM_INPUT" > sentry-event.json
          fi

          echo "Sentry payload saved to sentry-event.json"

          # Quick debug view in logs
          jq '
            (.event // .issue)
            | {
                title,
                level,
                platform,
                message: (.message // .metadata.value // .metadata.type)
              }
          ' sentry-event.json || cat sentry-event.json

      - name: Build GitHub issue body (jq)
        id: build_body
        run: |
          jq -r '
            def nl:"\n";
            def safe(v): if v == null then "" else v end;

            .issue as $issue
            | .event as $event

            | "Sentry reported an error in environment: " + (safe(
                  (
                    ($event.tags // [])
                    | map(select(.[0] == "environment"))[0][1]
                  )
                )) + nl + nl

            + "Level: " + safe($issue.level) + nl
            + "Error type: " + safe($issue.metadata.type) + nl
            + "Message: " + (safe($issue.metadata.value) // safe($event.message)) + nl + nl

            + "Summary:" + nl
            + "Culprit: " + safe($issue.culprit) + nl
            + "Location: " + safe($issue.metadata.filename) + " :: " + safe($issue.metadata.function) + nl
            + "Request URL: " + safe($event.request.url) + nl
            + "Sentry link: " + safe($event.web_url) + nl + nl

            + "Recent stacktrace frames:" + nl
            + (
                if ($event.exception.values[0].stacktrace.frames | length) > 0 then
                  (
                    $event.exception.values[0].stacktrace.frames[-5:]
                    | map(
                        "- " + (.filename // "?")
                        + ":" + ((.lineno // 0) | tostring)
                        + " â€” " + (.function // "")
                      )
                    | join(nl)
                  )
                else "- No frames available"
                end
              ) + nl + nl

            + "Event snapshot (for Copilot / debugging):" + nl
            + "```json" + nl
            + ($event | tojson) + nl
            + "```" + nl + nl
            + "This issue was created automatically from a Sentry alert. Please investigate and fix."
          ' sentry-event.json > issue-body.txt
          echo "Issue body written to issue-body.txt"

      - name: Create GitHub issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const payload = context.payload.client_payload || {};
            const sentry = payload.sentry || {};
            const issue = sentry.issue || {};

            const title = `Sentry: ${issue.title || "Unknown error"}`;
            const body = fs.readFileSync("issue-body.txt", "utf8");

            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["sentry", "bug"],
            });

            core.setOutput("issue_id", res.data.node_id);
            core.setOutput("issue_number", res.data.number);
            core.info(`Created issue #${res.data.number}`);

      - name: Fetch Copilot Actor ID automatically
        id: copilot
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"

          id=$(gh api graphql -f query='
            query($owner:String!, $repo:String!) {
              repository(owner:$owner, name:$repo) {
                suggestedActors(capabilities:[CAN_BE_ASSIGNED], first:50) {
                  nodes {
                    login
                    id
                  }
                }
              }
            }' \
            -f owner="$owner" -f repo="$repo" | jq -r '.data.repository.suggestedActors.nodes[]? | select(.login|contains("copilot")) | .id' )

          echo "COPILOT_ACTOR_ID=$id" >> $GITHUB_ENV

      - name: Assign to Copilot
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_ID: ${{ steps.create_issue.outputs.issue_id }}
        run: |
          gh api graphql -f query='
            mutation($issueId: ID!, $actorId: ID!) {
              replaceActorsForAssignable(input: { assignableId: $issueId, actorIds: [$actorId] }) {
                assignable { __typename }
              }
            }
          ' -f issueId="$ISSUE_ID" -f actorId="$COPILOT_ACTOR_ID"

          echo "ðŸ¤– Copilot has been assigned â€” watch for a PR!"