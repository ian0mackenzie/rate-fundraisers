name: Sentry event alert â€“ Create issue + Assign to Copilot

on:
  repository_dispatch:
    types: [sentry_event_alert]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  COPILOT_ACTOR_ID: "BOT_kgDOC9w8XQ"   # â† keep this the same (yours)

jobs:
  create_and_assign_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse incoming Sentry payload into sentry-event.json
        env:
          DATA: ${{ toJson(github.event.client_payload.sentry) }}
        run: |
          echo "$DATA" > sentry-event.json
          echo "Payload received and written to file."

      - name: Build GitHub issue body from Sentry event
        id: build_body
        run: |
          BODY=$(jq -r '
            def nl:"\n";
            def safe(v): if v==null then "" else v end;

            .issue as $issue
            | .event as $event

            | "Sentry Alert\n\n"
            + "Message: " + safe($issue.metadata.value) + nl
            + "Error: " + safe($issue.metadata.type) + nl
            + "File: " + safe($issue.metadata.filename) + nl
            + "URL: " + safe(($event.request.url // $event.web_url)) + nl + nl
            + "Stack Trace:\n"
            + (
                if ($event.exception.values[0].stacktrace.frames | length) > 0 then
                  ($event.exception.values[0].stacktrace.frames[-5:] 
                    | map("- " + (.filename // "?") + ":" + (.lineno|tostring) + " â€” " + (.function // ""))
                    | join(nl)
                  )
                else "- No frames available"
              ) + nl + nl
            + "Raw Event JSON:\n```json\n" + ( $event | tostring ) + "\n```"
          ' sentry-event.json)

          BODY_ESCAPED=${BODY//'%'/'%25'}
          BODY_ESCAPED=${BODY_ESCAPED//$'\n'/'%0A'}
          echo "body=$BODY_ESCAPED" >> "$GITHUB_OUTPUT"

      - name: Create GitHub issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = "Sentry: " + "${{ github.event.client_payload.sentry.issue.title }}";
            const body = `${{ steps.build_body.outputs.body }}`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["sentry", "bug"]
            });

            core.setOutput("issue_id", issue.data.node_id);
            core.setOutput("issue_number", issue.data.number);
            console.log("Created issue #" + issue.data.number);

      - name: Assign to GitHub Copilot Coding Agent ðŸ¤–
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_ID: ${{ steps.create_issue.outputs.issue_id }}
        run: |
          echo "Assigning Copilot to Sentry issue..."

          gh api graphql -f query='
            mutation($issueId:ID!, $actorId:ID!) {
              replaceActorsForAssignable(input:{assignableId:$issueId, actorIds:[$actorId]}) {
                assignable { __typename }
              }
            }' \
          -f issueId=$ISSUE_ID \
          -f actorId=$COPILOT_ACTOR_ID

          echo "âœ” Copilot assigned!"
