# docker/apache-http.conf - HTTP only, ALB handles HTTPS
<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html/public
    DirectoryIndex index.php

    <Directory /var/www/html/public>
        AllowOverride All
        Require all granted
        
        # Handle Symfony routing
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]
    </Directory>

    # Trust ALB forwarded headers for HTTPS detection
    RemoteIPHeader X-Forwarded-For
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16

    # Set HTTPS environment variable when ALB forwards HTTPS traffic
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    SetEnvIf X-Forwarded-Proto "https" HTTP_X_FORWARDED_SSL=On

    # Security headers (ALB can also set these, but good to have both)
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Force HTTPS redirects (when behind ALB)
    # Uncomment if you want to force HTTPS
    # RewriteEngine On
    # RewriteCond %{HTTP:X-Forwarded-Proto} !https
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Error and access logs
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined

    # PHP settings
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
    php_value memory_limit 256M
    php_value max_execution_time 300
    
    # Ensure PHP knows about HTTPS when behind ALB
    php_value auto_prepend_file /var/www/html/docker/https-detection.php
</VirtualHost>